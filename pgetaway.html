<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <body>
    <div class="container">



        <div class="order-summary">
            <h3>Order Summary</h3>
            <div id="orderItems"></div>
            <div class="total-section">
                <p>Shipping: <span id="shippingCost">£2.99</span></p>
                <p>Total to pay: <span id="checkoutAmount"></span></p>
            </div>
        </div>





        <form id="checkoutForm" onsubmit="processCheckout(event)">
            <div class="row">
                <div class="col">
                    <h3 class="title">billing address</h3>
                    
                    <div class="inputBox">
                        <span>full name :</span>
                        <input type="text" id="fullName" required>
                        <div class="error" id="fullNameError">Please enter your full name</div>
                    </div>
                    <div class="inputBox">
                        <span>email :</span>
                        <input type="email" id="email" required>
                        <div class="error" id="emailError">Please enter a valid email</div>
                    </div>
                    <div class="inputBox">
                        <span>address :</span>
                        <input type="text" id="address" required>
                        <div class="error" id="addressError">Please enter your address</div>
                    </div>
                    <div class="flex">
                    <div class="inputBox">
                        <span>city :</span>
                        <input type="text" id="city" required>
                        <div class="error" id="cityError">Please enter your city</div>
                    </div>

                    <div class="inputBox">
                        <span>post code :</span>
                        <input type="text" id="postCode" required>
                        <div class="error" id="postCodeError">Please enter your post code</div>
                    </div>
                </div>
                </div>

                <div class="col">
                    <h3 class="title">payment</h3>

                    <div class="inputBox">
                        <span>cards accepted :</span>
                        <img src="img/card_img.png" alt="">
                    </div>
                    <div class="inputBox">
                        <span>name on card :</span>
                        <input type="text" id="cardName" required>
                        <div class="error" id="cardNameError">Please enter name on card</div>
                    </div>
                    <div class="inputBox">
                        <span>credit card number :</span>
                        <input type="number" id="cardNumber" required>
                        <div class="error" id="cardNumberError">Please enter a valid card number</div>
                    </div>

                    <div class="flex">
                        <div class="inputBox">
                            <span>exp date :</span>
                            <input type="text" id="expYear" maxlength="5" placeholder="MM/YY" required>
                            <div class="error" id="expYearError">Please enter valid expiration date (MM/YY)</div>
                        </div>
                        <div class="inputBox">
                            <span>CVV :</span>
                            <input type="text" id="cvv" required>
                            <div class="error" id="cvvError">Please enter CVV</div>
                        </div>
                    </div>
                </div>
            </div>

            <input type="submit" value="Complete Purchase" class="submit-btn">
        </form>
    </div>




















    <div class="purchase-notification" id="purchaseNotification">
        <div class="purchase-notification-header">Order Confirmation</div>
        <div class="purchase-message">
            <div class="success-icon">
                <i class="fa fa-check-circle" aria-hidden="true"></i>
            </div>
            <div class="message-text"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Retrieve cart data from localStorage
        const cartItems = JSON.parse(localStorage.getItem('checkoutItems'));
        const total = localStorage.getItem('checkoutTotal');

        // Display order summary
        const orderItemsList = document.getElementById('order-items');
        const orderTotal = document.getElementById('order-total');

        cartItems.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.name} - Quantity: ${item.quantity} - Subtotal: £${item.subtotal.toFixed(2)}`;
            orderItemsList.appendChild(li);
        });

        orderTotal.textContent = total;

        // Stripe configuration
        const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY');
        const elements = stripe.elements();
        const card = elements.create('card');
        card.mount('#card-element');

        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            submitButton.disabled = true;

            const { token, error } = await stripe.createToken(card);

            if (error) {
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = error.message;
                submitButton.disabled = false;
            } else {
                // Process the payment and store order details in Firestore
                const order = {
                    items: cartItems,
                    total: total,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    paymentToken: token.id
                };

                try {
                    const docRef = await db.collection('orders').add(order);
                    console.log('Order stored with ID: ', docRef.id);
                    // Clear cart data from localStorage
                    localStorage.removeItem('cartData');
                    localStorage.removeItem('checkoutItems');
                    localStorage.removeItem('checkoutTotal');
                    // Redirect to a success page or show a success message
                    alert('Payment successful! Order ID: ' + docRef.id);
                    // You can redirect to a success page here
                    // window.location.href = 'success.html';
                } catch (error) {
                    console.error('Error storing order: ', error);
                    alert('An error occurred while processing your order. Please try again.');
                    submitButton.disabled = false;
                }
            }
        });
    </script>
</body>
</html>