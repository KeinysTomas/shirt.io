<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Add EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("rwp1ZizG0cGBettBt");
        })();
    </script>
    <!-- Add Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWkJwdhk9VdT24ykFVv4TpkNtm_WDXMh4",
            authDomain: "shirtkj.firebaseapp.com",
            projectId: "shirtkj",
            storageBucket: "shirtkj.firebasestorage.app",
            messagingSenderId: "643296189935",
            appId: "1:643296189935:web:34d6b484eb43aaad35aa1a",
            measurementId: "G-ZLBVCE5TZV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
    </script>
</head>
<body>
    <div class="container">



        <div class="order-summary">
            <h3>Order Summary</h3>
            <div id="orderItems"></div>
            <div class="total-section">
                <p>Shipping: <span id="shippingCost">Â£2.99</span></p>
                <p>Total to pay: <span id="checkoutAmount"></span></p>
            </div>
        </div>





        <form id="checkoutForm" onsubmit="processCheckout(event)">
            <div class="row">
                <div class="col">
                    <h3 class="title">billing address</h3>
                    
                    <div class="inputBox">
                        <span>full name :</span>
                        <input type="text" id="fullName" required>
                        <div class="error" id="fullNameError">Please enter your full name</div>
                    </div>
                    <div class="inputBox">
                        <span>email :</span>
                        <input type="email" id="email" required>
                        <div class="error" id="emailError">Please enter a valid email</div>
                    </div>
                    <div class="inputBox">
                        <span>address :</span>
                        <input type="text" id="address" required>
                        <div class="error" id="addressError">Please enter your address</div>
                    </div>
                    <div class="flex">
                    <div class="inputBox">
                        <span>city :</span>
                        <input type="text" id="city" required>
                        <div class="error" id="cityError">Please enter your city</div>
                    </div>

                    <div class="inputBox">
                        <span>post code :</span>
                        <input type="text" id="postCode" required>
                        <div class="error" id="postCodeError">Please enter your post code</div>
                    </div>
                </div>
                </div>

                <div class="col">
                    <h3 class="title">payment</h3>

                    <div class="inputBox">
                        <span>cards accepted :</span>
                        <img src="img/card_img.png" alt="">
                    </div>
                    <div class="inputBox">
                        <span>name on card :</span>
                        <input type="text" id="cardName" required>
                        <div class="error" id="cardNameError">Please enter name on card</div>
                    </div>
                    <div class="inputBox">
                        <span>credit card number :</span>
                        <input type="number" id="cardNumber" required>
                        <div class="error" id="cardNumberError">Please enter a valid card number</div>
                    </div>

                    <div class="flex">
                        <div class="inputBox">
                            <span>exp date :</span>
                            <input type="text" id="expYear" maxlength="5" placeholder="MM/YY" required>
                            <div class="error" id="expYearError">Please enter valid expiration date (MM/YY)</div>
                        </div>
                        <div class="inputBox">
                            <span>CVV :</span>
                            <input type="text" id="cvv" required>
                            <div class="error" id="cvvError">Please enter CVV</div>
                        </div>
                    </div>
                </div>
            </div>

            <input type="submit" value="Complete Purchase" class="submit-btn">
        </form>
    </div>




















    <div class="purchase-notification" id="purchaseNotification">
        <div class="purchase-notification-header">Order Confirmation</div>
        <div class="purchase-message">
            <div class="success-icon">
                <i class="fa fa-check-circle" aria-hidden="true"></i>
            </div>
            <div class="message-text"></div>
        </div>
    </div>


    <script type="module">
        import OrderStorage from './OrderStorage.js';

        document.addEventListener('DOMContentLoaded', function() {
            // Your existing code for displaying total amount and order items
        });

        function showPurchaseNotification(message) {
            // Your existing showPurchaseNotification function
        }

        function sendOrderConfirmationEmail(order) {
            // Your existing sendOrderConfirmationEmail function
        }

        async function processCheckout(event) {
            event.preventDefault();
            
            document.querySelectorAll('.error').forEach(error => error.style.display = 'none');

            const formData = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                address: document.getElementById('address').value.trim(),
                city: document.getElementById('city').value.trim(),
                postCode: document.getElementById('postCode').value.trim(),
                cardName: document.getElementById('cardName').value.trim(),
                cardNumber: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                expYear: document.getElementById('expYear').value.trim(),
                cvv: document.getElementById('cvv').value.trim()
            };

            const validations = {
                // Your existing validations
            };

            let isValid = true;

            for (const [field, value] of Object.entries(formData)) {
                if (!validations[field](value)) {
                    document.getElementById(`${field}Error`).style.display = 'block';
                    isValid = false;
                }
            }

            if (isValid) {
                try {
                    const order = await OrderStorage.saveOrder(formData);
                    simulatePaymentProcessing(order);
                } catch (error) {
                    console.error('Error saving order:', error);
                    showPurchaseNotification('There was an error processing your order. Please try again.');
                }
            }
        }

        function simulatePaymentProcessing(order) {
            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.value = 'Processing...';
            submitBtn.disabled = true;

            sendOrderConfirmationEmail(order)
                .then(response => {
                    console.log('Email sent successfully:', response);
                    
                    setTimeout(() => {
                        const successMessage = `Order Successfully Placed!\nOrder ID: ${order.orderId}\nTotal Paid: ${order.totalAmount}\nA confirmation email has been sent to ${order.customerDetails.email}`;
                        
                        showPurchaseNotification(successMessage);
                        
                        OrderStorage.clearCart();
                
                        // Delay redirect to allow notification to be visible
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 3000);
                    }, 2000);
                })
                .catch(error => {
                    console.error('Failed to send email:', error);
                    showPurchaseNotification('Order placed successfully, but there was an issue sending the confirmation email. Please check your order details in your account.');
                    OrderStorage.clearCart();
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                });
        }

        window.processCheckout = processCheckout;
    </script>

    <!-- Remove these script tags as they are no longer needed -->
     

</body>
</html>